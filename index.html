<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ‡Ø¯ | Fahad App</title>
    
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4f46e5; --primary-soft: #eef2ff;
            --bg: #f8fafc; --surface: #ffffff;
            --text: #0f172a; --text-light: #64748b;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --border: #e2e8f0; --radius: 18px;
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.08);
        }
        [data-theme="dark"] {
            --bg: #0f172a; --surface: #1e293b; 
            --text: #f8fafc; --text-light: #94a3b8; 
            --border: #334155; --primary-soft: #1e1b4b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            font-family: 'Tajawal', sans-serif; margin: 0; background: var(--bg); color: var(--text);
            padding-bottom: 90px; padding-top: env(safe-area-inset-top); user-select: none; transition: 0.3s;
        }

        /* --- HEADER --- */
        header {
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 50; background: var(--bg); backdrop-filter: blur(10px);
        }
        .app-title { font-size: 1.4rem; font-weight: 800; color: var(--primary); margin: 0; }
        .app-title span { color: var(--text); font-weight: 400; font-size: 1rem; }
        .theme-btn { background: var(--surface); border: 1px solid var(--border); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow); color: var(--text); cursor: pointer; }

        /* --- BOTTOM NAVIGATION --- */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px);
            border-radius: 25px; height: 65px; display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 1000; border: 1px solid rgba(255,255,255,0.2);
        }
        [data-theme="dark"] .bottom-nav { background: rgba(30, 41, 59, 0.9); border-color: rgba(255,255,255,0.05); }
        
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-light); font-size: 0.7rem; font-weight: 500; width: 50px; cursor: pointer; transition: 0.2s;
        }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; transition: 0.2s; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item.active i { filter: drop-shadow(0 4px 6px rgba(79, 70, 229, 0.4)); }

        /* --- CARDS & LAYOUT --- */
        .container { padding: 0 20px; animation: fadeIn 0.4s ease-out; }
        
        .card {
            background: var(--surface); border-radius: var(--radius); padding: 16px;
            margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border);
            position: relative; overflow: hidden;
        }

        /* --- STATS GRID --- */
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--surface); padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); text-align: center; }
        .stat-box h3 { margin: 0; font-size: 1.6rem; color: var(--primary); font-weight: 800; }
        .stat-box p { margin: 5px 0 0; font-size: 0.8rem; color: var(--text-light); }

        /* --- POS (CASHIER) --- */
        .search-bar {
            width: 100%; padding: 15px 20px; border-radius: 50px; border: none;
            background: var(--surface); box-shadow: var(--shadow); font-family: inherit; font-size: 1rem;
            color: var(--text); margin-bottom: 15px; border: 1px solid var(--border);
        }
        
        .cat-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none; }
        .cat-chip {
            padding: 8px 18px; background: var(--surface); border-radius: 30px; border: 1px solid var(--border);
            white-space: nowrap; font-size: 0.9rem; font-weight: 600; color: var(--text-light); transition: 0.2s;
        }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        .prod-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .prod-card {
            background: var(--surface); border-radius: 16px; overflow: hidden; border: 1px solid var(--border);
            position: relative; transition: 0.1s;
        }
        .prod-card:active { transform: scale(0.96); border-color: var(--primary); }
        .prod-img { width: 100%; height: 110px; object-fit: cover; background: #f1f5f9; }
        .prod-details { padding: 10px; }
        .prod-title { font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .prod-price { color: var(--success); font-weight: 800; font-size: 1rem; }
        .badge { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7rem; backdrop-filter: blur(4px); }

        /* --- CART BAR (Sticky) --- */
        .cart-bar {
            position: fixed; bottom: 95px; left: 20px; right: 20px;
            background: var(--text); color: var(--bg); padding: 15px 20px;
            border-radius: 20px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 900; cursor: pointer;
            transform: translateY(150%); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .cart-bar.show { transform: translateY(0); }
        .cart-count { background: var(--primary); color: white; padding: 2px 10px; border-radius: 10px; font-weight: bold; font-size: 0.9rem; }

        /* --- MODAL / BOTTOM SHEET --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; opacity: 0; pointer-events: none; transition: 0.3s;
            backdrop-filter: blur(3px);
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .bottom-sheet {
            position: absolute; bottom: 0; width: 100%; background: var(--surface);
            border-radius: 30px 30px 0 0; padding: 25px; max-height: 85vh; overflow-y: auto;
            transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-overlay.open .bottom-sheet { transform: translateY(0); }

        /* --- LIST ITEMS (Inventory/Debts) --- */
        .list-item {
            display: flex; align-items: center; gap: 15px; padding: 12px 0; border-bottom: 1px dashed var(--border);
        }
        .list-item:last-child { border-bottom: none; }
        .list-img { width: 45px; height: 45px; border-radius: 10px; object-fit: cover; background: #eee; }
        .list-info { flex: 1; }
        .list-info h4 { margin: 0; font-size: 0.95rem; font-weight: 700; }
        .list-info p { margin: 2px 0 0; font-size: 0.8rem; color: var(--text-light); }
        .list-action { background: var(--primary-soft); color: var(--primary); border: none; width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; cursor: pointer; }
        .list-action.delete { background: #fee2e2; color: var(--danger); }

        /* --- FORMS --- */
        input, select {
            width: 100%; padding: 14px; background: var(--bg); border: 2px solid var(--border);
            border-radius: 14px; font-family: inherit; font-size: 1rem; color: var(--text);
            margin-bottom: 12px; transition: 0.2s;
        }
        input:focus { border-color: var(--primary); background: var(--surface); }
        .btn {
            width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 700; font-size: 1rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            font-family: inherit; transition: 0.1s;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3); }
        .btn-danger { background: var(--danger); color: white; }

        /* --- HELPERS --- */
        .page { display: none; } .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border); border-radius: 16px; padding: 20px; text-align: center;
            color: var(--text-light); background: var(--bg); cursor: pointer; margin-bottom: 15px;
        }
        .upload-area img { max-height: 100px; display: none; margin: 10px auto; border-radius: 10px; }

    </style>
</head>
<body data-theme="light">

    <header>
        <div>
            <h1 class="app-title">Ø§Ù„ÙÙ‡Ø¯ <span>POS</span></h1>
        </div>
        <div class="theme-btn" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></div>
    </header>

    <main>

        <section id="dashboard" class="page active container">
            <h2 style="margin-bottom:15px">Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…</h2>
            <div class="stats-row">
                <div class="stat-box"><h3><span id="d-daily">0</span></h3><p>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p></div>
                <div class="stat-box"><h3><span id="d-profit" style="color:var(--success)">0</span></h3><p>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</p></div>
            </div>
            <div class="stats-row">
                <div class="stat-box"><h3><span id="d-debts" style="color:var(--danger)">0</span></h3><p>Ø§Ù„Ø¯ÙŠÙˆÙ†</p></div>
                <div class="stat-box"><h3><span id="d-stock">0</span></h3><p>Ø§Ù„Ù…Ø®Ø²Ù†</p></div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                    <h3>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h3>
                    <i class="fa-solid fa-chart-line" style="color:var(--primary)"></i>
                </div>
                <div style="height:200px"><canvas id="salesChart"></canvas></div>
            </div>
        </section>

        <section id="pos" class="page container">
            <input type="text" id="searchPos" class="search-bar" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." onkeyup="renderPos()">
            
            <div class="cat-list" id="catList">
                <div class="cat-chip active" onclick="filterCat('Ø§Ù„ÙƒÙ„', this)">Ø§Ù„ÙƒÙ„</div>
                </div>

            <div class="prod-grid" id="posGrid">
                </div>

            <div class="cart-bar" id="cartBar" onclick="toggleCart()">
                <div style="display:flex; align-items:center; gap:10px">
                    <div class="cart-count" id="cartCount">0</div>
                    <span>Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span>
                </div>
                <span style="font-weight:800; font-size:1.1rem" id="cartBarTotal">0</span>
            </div>
        </section>

        <section id="store" class="page container">
            <div class="card">
                <h3 style="margin-top:0">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
                <div class="upload-area" onclick="document.getElementById('imgInput').click()">
                    <i class="fa-solid fa-camera" style="font-size:1.5rem; margin-bottom:5px"></i><br>
                    <span>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</span>
                    <img id="previewImg">
                    <input type="file" id="imgInput" accept="image/*" hidden onchange="handleImage(this)">
                </div>
                <div style="display:flex; gap:10px">
                    <input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
                    <select id="pCat" style="width:40%"><option>Ø¹Ø§Ù…</option><option>Ø±Ø¬Ø§Ù„ÙŠ</option><option>Ù†Ø³Ø§Ø¦ÙŠ</option></select>
                </div>
                <div style="display:flex; gap:10px">
                    <input type="number" id="pPrice" placeholder="Ø¨ÙŠØ¹">
                    <input type="number" id="pCost" placeholder="Ø´Ø±Ø§Ø¡">
                    <input type="number" id="pQty" placeholder="Ø§Ù„Ø¹Ø¯Ø¯">
                </div>
                <button class="btn btn-primary" onclick="addProduct()">Ø­ÙØ¸ <i class="fa-solid fa-check"></i></button>
            </div>

            <h3 style="margin:20px 0 10px 0">Ø§Ù„Ù…Ø®Ø²Ù†</h3>
            <div class="card" id="storeList" style="padding:0">
                </div>
        </section>

        <section id="menu" class="page container">
            <h2 style="margin-bottom:20px">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h2>
            
            <div class="card" onclick="nav('debts')" style="display:flex; align-items:center; gap:15px">
                <div style="background:#fee2e2; width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--danger)"><i class="fa-solid fa-book"></i></div>
                <div style="flex:1"><h4>Ø¯ÙØªØ± Ø§Ù„Ø¯ÙŠÙˆÙ†</h4><p style="margin:0;font-size:0.8rem">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p></div>
                <i class="fa-solid fa-chevron-left" style="color:var(--text-light); font-size:0.8rem"></i>
            </div>

            <div class="card" onclick="nav('invoices')" style="display:flex; align-items:center; gap:15px">
                <div style="background:#e0e7ff; width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--primary)"><i class="fa-solid fa-file-invoice"></i></div>
                <div style="flex:1"><h4>Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h4><p style="margin:0;font-size:0.8rem">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</p></div>
                <i class="fa-solid fa-chevron-left" style="color:var(--text-light); font-size:0.8rem"></i>
            </div>
            
             <div class="card" onclick="exportData()" style="display:flex; align-items:center; gap:15px">
                <div style="background:#dcfce7; width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--success)"><i class="fa-solid fa-download"></i></div>
                <div style="flex:1"><h4>Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</h4><p style="margin:0;font-size:0.8rem">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p></div>
            </div>
            
             <div class="card" onclick="document.getElementById('fileIn').click()" style="display:flex; align-items:center; gap:15px">
                <div style="background:#f1f5f9; width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--text)"><i class="fa-solid fa-upload"></i></div>
                <div style="flex:1"><h4>Ø§Ø³ØªØ±Ø¬Ø§Ø¹</h4><p style="margin:0;font-size:0.8rem">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù</p></div>
                <input type="file" id="fileIn" hidden onchange="importData(event)">
            </div>
            
            <button class="btn btn-danger" style="margin-top:20px" onclick="resetSys()">ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </section>

        <section id="debts" class="page container">
            <button class="btn" style="background:transparent; color:var(--text); justify-content:flex-start; padding-left:0" onclick="nav('menu')"><i class="fa-solid fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</button>
            <h2>Ø§Ù„Ø¯ÙŠÙˆÙ†</h2>
            <div class="card" id="debtList" style="padding:0"></div>
        </section>
        
        <section id="invoices" class="page container">
            <button class="btn" style="background:transparent; color:var(--text); justify-content:flex-start; padding-left:0" onclick="nav('menu')"><i class="fa-solid fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</button>
            <h2>Ø§Ù„Ø³Ø¬Ù„</h2>
            <div class="card" id="invList" style="padding:0"></div>
        </section>

    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="nav('dashboard', this)"><i class="fa-solid fa-chart-pie"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav-item" onclick="nav('pos', this)"><i class="fa-solid fa-cash-register"></i>Ø¨ÙŠØ¹</div>
        <div class="nav-item" onclick="nav('store', this)"><i class="fa-solid fa-boxes-stacked"></i>Ù…Ø®Ø²Ù†</div>
        <div class="nav-item" onclick="nav('menu', this)"><i class="fa-solid fa-bars"></i>Ù‚Ø§Ø¦Ù…Ø©</div>
    </nav>

    <div class="modal-overlay" id="cartModal">
        <div class="bottom-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                <h2 style="margin:0">Ø§Ù„Ø³Ù„Ø©</h2>
                <div onclick="toggleCart()" style="padding:10px; cursor:pointer"><i class="fa-solid fa-xmark"></i></div>
            </div>
            
            <div id="cartItems" style="max-height:40vh; overflow-y:auto; margin-bottom:20px"></div>
            
            <div style="background:var(--bg); padding:15px; border-radius:20px; margin-bottom:15px">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:700">
                    <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</span><span id="cartTotalDisplay">0</span>
                </div>
                <div style="display:flex; gap:10px; margin-bottom:10px">
                    <select id="payMethod" style="margin-bottom:0"><option value="cash">Ù†Ù‚Ø¯Ø§Ù‹ ğŸ’µ</option><option value="debt">Ø¢Ø¬Ù„ (Ø¯ÙŠÙ†) ğŸ“’</option></select>
                </div>
                <input type="text" id="custName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¯ÙŠÙ†)" style="display:none; margin-bottom:0">
            </div>
            
            <button class="btn btn-primary" onclick="checkout()">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹</button>
        </div>
    </div>

    <div id="invoice-print" style="display:none"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- DATA ---
        let products = JSON.parse(localStorage.getItem('fhd_p')) || [];
        let sales = JSON.parse(localStorage.getItem('fhd_s')) || [];
        let debts = JSON.parse(localStorage.getItem('fhd_d')) || [];
        let cart = [];
        let tempImg = "";
        let activeCat = 'Ø§Ù„ÙƒÙ„';

        // --- INIT ---
        const theme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', theme);
        refreshAll();

        // --- NAVIGATION ---
        function nav(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
            if(id === 'pos') renderPos();
            if(id === 'dashboard') initChart();
        }

        // --- STORE LOGIC ---
        function handleImage(input) {
            const file = input.files[0];
            if(file){
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const scale = 300 / img.width;
                        canvas.width = 300; canvas.height = img.height * scale;
                        ctx.drawImage(img,0,0,canvas.width,canvas.height);
                        tempImg = canvas.toDataURL('image/jpeg',0.7);
                        document.getElementById('previewImg').src = tempImg;
                        document.getElementById('previewImg').style.display = 'block';
                    }
                }
                reader.readAsDataURL(file);
            }
        }

        function addProduct() {
            const n = document.getElementById('pName').value;
            const p = parseFloat(document.getElementById('pPrice').value);
            const q = parseInt(document.getElementById('pQty').value);
            const c = document.getElementById('pCat').value;
            const cost = parseFloat(document.getElementById('pCost').value) || 0;

            if(n && p && q) {
                products.push({id:Date.now(), name:n, price:p, qty:q, cat:c, cost:cost, img:tempImg});
                save(); renderStore(); alert("ØªÙ…!");
                document.getElementById('pName').value=''; document.getElementById('previewImg').style.display='none'; tempImg="";
            }
        }

        function renderStore() {
            document.getElementById('storeList').innerHTML = products.map((p, i) => `
                <div class="list-item" style="padding:15px">
                    <img src="${p.img||'https://via.placeholder.com/50'}" class="list-img">
                    <div class="list-info"><h4>${p.name}</h4><p>${p.qty} Ù‚Ø·Ø¹Ø© | ${p.price}</p></div>
                    <button class="list-action delete" onclick="delProd(${i})"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
            document.getElementById('d-stock').innerText = products.reduce((a,b)=>a+b.qty,0);
        }
        function delProd(i) { if(confirm("Ø­Ø°ÙØŸ")) { products.splice(i,1); save(); renderStore(); } }

        // --- POS LOGIC ---
        function filterCat(cat, el) {
            activeCat = cat;
            document.querySelectorAll('.cat-chip').forEach(c=>c.classList.remove('active'));
            el.classList.add('active');
            renderPos();
        }

        function renderPos() {
            const q = document.getElementById('searchPos').value.toLowerCase();
            
            // Render Categories
            const cats = ['Ø§Ù„ÙƒÙ„', ...new Set(products.map(p=>p.cat))];
            let catHTML = `<div class="cat-chip ${activeCat==='Ø§Ù„ÙƒÙ„'?'active':''}" onclick="filterCat('Ø§Ù„ÙƒÙ„', this)">Ø§Ù„ÙƒÙ„</div>`;
            cats.forEach(c => {
                if(c !== 'Ø§Ù„ÙƒÙ„') catHTML += `<div class="cat-chip ${activeCat===c?'active':''}" onclick="filterCat('${c}', this)">${c}</div>`;
            });
            document.getElementById('catList').innerHTML = catHTML;

            // Render Grid
            let list = products.filter(p => p.name.toLowerCase().includes(q));
            if(activeCat !== 'Ø§Ù„ÙƒÙ„') list = list.filter(p => p.cat === activeCat);

            document.getElementById('posGrid').innerHTML = list.map(p => `
                <div class="prod-card" onclick="addToCart(${p.id})">
                    <div class="badge">${p.qty}</div>
                    <img src="${p.img||'https://via.placeholder.com/150'}" class="prod-img">
                    <div class="prod-details">
                        <div class="prod-title">${p.name}</div>
                        <div class="prod-price">${p.price}</div>
                    </div>
                </div>
            `).join('');
            updateCartUI();
        }

        function addToCart(id) {
            const p = products.find(x=>x.id===id);
            if(p.qty<=0) return alert("Ù†ÙØ°Øª Ø§Ù„ÙƒÙ…ÙŠØ©");
            const exist = cart.find(x=>x.id===id);
            if(exist) { 
                if(exist.qty < p.qty) exist.qty++; 
                else return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ù„Ù…Ø²ÙŠØ¯");
            } else {
                cart.push({id:p.id, name:p.name, price:p.price, cost:p.cost, qty:1});
            }
            updateCartUI();
        }

        function updateCartUI() {
            const count = cart.reduce((a,b)=>a+b.qty,0);
            const total = cart.reduce((a,b)=>a+(b.price*b.qty),0);
            
            document.getElementById('cartCount').innerText = count;
            document.getElementById('cartBarTotal').innerText = total.toLocaleString();
            
            const bar = document.getElementById('cartBar');
            if(count > 0) bar.classList.add('show');
            else { bar.classList.remove('show'); document.getElementById('cartModal').classList.remove('open'); }

            document.getElementById('cartItems').innerHTML = cart.map((c,i)=>`
                <div class="list-item">
                    <div class="list-info"><h4>${c.name}</h4><p>${c.price} x ${c.qty}</p></div>
                    <strong style="margin-left:10px">${c.price*c.qty}</strong>
                    <button class="list-action delete" onclick="cart.splice(${i},1); updateCartUI()"><i class="fa-solid fa-minus"></i></button>
                </div>
            `).join('');
            document.getElementById('cartTotalDisplay').innerText = total.toLocaleString();
        }

        function toggleCart() {
            document.getElementById('cartModal').classList.toggle('open');
        }

        document.getElementById('payMethod').onchange = function() {
            document.getElementById('custName').style.display = this.value === 'debt' ? 'block' : 'none';
        }

        function checkout() {
            const method = document.getElementById('payMethod').value;
            const name = document.getElementById('custName').value;
            if(method==='debt' && !name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†");
            
            const total = cart.reduce((a,b)=>a+(b.price*b.qty),0);
            const cost = cart.reduce((a,b)=>a+(b.cost*b.qty),0);

            // Deduct Stock
            cart.forEach(c => { const p = products.find(x=>x.id===c.id); if(p) p.qty-=c.qty; });

            const sale = {
                id: "INV"+Date.now().toString().slice(-4), client: name||"Ø¹Ø§Ù…", 
                total: total, profit: total-cost, items: [...cart], 
                date: new Date().toLocaleDateString('ar-EG'), type: method
            };

            sales.push(sale);
            if(method==='debt') debts.push({name:name, amount:total, date:sale.date});

            save(); cart=[]; updateCartUI(); renderPos(); renderDebts(); initChart();
            alert("ØªÙ… Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!");
        }

        // --- DASHBOARD & LISTS ---
        function initChart() {
            const today = new Date().toLocaleDateString('ar-EG');
            document.getElementById('d-daily').innerText = sales.filter(s=>s.date===today).reduce((a,b)=>a+b.total,0).toLocaleString();
            document.getElementById('d-profit').innerText = sales.reduce((a,b)=>a+b.profit,0).toLocaleString();
            document.getElementById('d-debts').innerText = debts.reduce((a,b)=>a+b.amount,0).toLocaleString();

            const ctx = document.getElementById('salesChart').getContext('2d');
            // Mock chart data for last 7 days logic would go here
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'],
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', data: [0,0,0,0,0,0, sales.reduce((a,b)=>a+b.total,0)],
                        borderColor: '#4f46e5', tension: 0.4, fill: true, backgroundColor: 'rgba(79, 70, 229, 0.1)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: {legend: {display: false}} }
            });
        }

        function renderDebts() {
            document.getElementById('debtList').innerHTML = debts.map((d, i) => `
                <div class="list-item" style="padding:15px">
                    <div style="background:#fee2e2; width:45px; height:45px; border-radius:10px; display:flex; align-items:center; justify-content:center; color:var(--danger)"><i class="fa-solid fa-user"></i></div>
                    <div class="list-info"><h4>${d.name}</h4><p>${d.date}</p></div>
                    <strong style="color:var(--danger)">${d.amount}</strong>
                    <button class="list-action" onclick="debts.splice(${i},1); save(); renderDebts();"><i class="fa-solid fa-check"></i></button>
                </div>
            `).join('');
        }

        function renderInvoices() {
            document.getElementById('invList').innerHTML = sales.slice().reverse().map(s => `
                <div class="list-item" style="padding:15px">
                    <div class="list-info"><h4>${s.id} | ${s.client}</h4><p>${s.date} - ${s.type}</p></div>
                    <strong>${s.total}</strong>
                </div>
            `).join('');
        }

        // --- SYSTEM ---
        function save() {
            localStorage.setItem('fhd_p', JSON.stringify(products));
            localStorage.setItem('fhd_s', JSON.stringify(sales));
            localStorage.setItem('fhd_d', JSON.stringify(debts));
            refreshAll();
        }
        function refreshAll() { renderStore(); renderDebts(); renderInvoices(); initChart(); }
        
        function toggleTheme() {
            const t = document.body.getAttribute('data-theme')==='light'?'dark':'light';
            document.body.setAttribute('data-theme', t); localStorage.setItem('theme', t);
        }
        function exportData(){
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify({products,sales,debts})], {type:'application/json'}));
            a.download = "Fahad_Backup.json"; a.click();
        }
        function importData(e){
            const r = new FileReader();
            r.onload = ev => {
                const d = JSON.parse(ev.target.result);
                products = d.products || []; sales = d.sales || []; debts = d.debts || [];
                save(); alert("ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹");
            };
            r.readAsText(e.target.files[0]);
        }
        function resetSys() { if(confirm("Ø­Ø°Ù Ø§Ù„ÙƒÙ„ØŸ")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
