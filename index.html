<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ‡Ø¯ Ø§Ù„Ø°ÙƒÙŠ | Fahad Smart POS</title>
    
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4f46e5; --primary-soft: #eef2ff;
            --bg: #f8fafc; --surface: #ffffff;
            --text: #0f172a; --text-light: #64748b;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --border: #e2e8f0; --radius: 16px;
            --shadow: 0 4px 20px -5px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] {
            --bg: #0f172a; --surface: #1e293b; --text: #f8fafc; --text-light: #94a3b8; --border: #334155; --primary-soft: #1e1b4b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            font-family: 'Tajawal', sans-serif; margin: 0; background: var(--bg); color: var(--text);
            padding-bottom: 100px; padding-top: env(safe-area-inset-top); user-select: none; transition: 0.3s;
        }

        /* HEADER */
        header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; background: var(--bg); backdrop-filter: blur(10px); }
        .app-title { font-size: 1.4rem; font-weight: 800; color: var(--primary); margin: 0; }
        .theme-btn { width: 35px; height: 35px; border-radius: 50%; background: var(--surface); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text); }

        /* NAV */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 15px; right: 15px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px);
            border-radius: 25px; height: 65px; display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); z-index: 1000; border: 1px solid rgba(0,0,0,0.05);
        }
        [data-theme="dark"] .bottom-nav { background: rgba(30, 41, 59, 0.95); border-color: rgba(255,255,255,0.1); }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: var(--text-light); transition: 0.2s; }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); font-weight: 700; }

        /* LAYOUT */
        .container { padding: 0 20px; animation: fadeIn 0.4s ease-out; }
        .card { background: var(--surface); border-radius: var(--radius); padding: 16px; margin-bottom: 15px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; }
        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: var(--surface); padding: 15px; border-radius: var(--radius); border: 1px solid var(--border); text-align: center; }
        .stat-box h3 { margin: 0; font-size: 1.4rem; color: var(--primary); font-weight: 800; }

        /* INPUTS */
        .search-bar { width: 100%; padding: 12px 20px; border-radius: 50px; border: 1px solid var(--border); background: var(--surface); color: var(--text); margin-bottom: 15px; font-family: inherit; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input, select { flex: 1; padding: 12px; border: 1px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); font-family: inherit; font-size: 1rem; }
        .btn { width: 100%; padding: 14px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: inherit; font-size: 1rem; transition: 0.1s; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
        .btn-danger { background: #fee2e2; color: var(--danger); }

        /* POS GRID */
        .cat-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; scrollbar-width: none; }
        .cat-chip { padding: 6px 16px; background: var(--surface); border-radius: 30px; border: 1px solid var(--border); font-size: 0.9rem; white-space: nowrap; cursor: pointer; }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        .prod-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .prod-card { background: var(--surface); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; position: relative; cursor: pointer; }
        .prod-card:active { border-color: var(--primary); transform: scale(0.98); }
        .prod-img { width: 100%; height: 110px; object-fit: cover; background: #f1f5f9; }
        .prod-details { padding: 10px; }
        .prod-title { font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .badge { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7rem; }

        /* CART BAR */
        .cart-bar { position: fixed; bottom: 100px; left: 20px; right: 20px; background: var(--text); color: var(--bg); padding: 15px 20px; border-radius: 50px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 15px 30px rgba(0,0,0,0.3); z-index: 900; cursor: pointer; transform: translateY(200%); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .cart-bar.show { transform: translateY(0); }
        .cart-count { background: var(--primary); color: white; padding: 2px 10px; border-radius: 10px; font-weight: bold; font-size: 0.9rem; }

        /* LISTS */
        .list-item { display: flex; align-items: center; gap: 15px; padding: 12px 0; border-bottom: 1px dashed var(--border); }
        .list-info { flex: 1; }
        .list-info h4 { margin: 0; font-size: 0.95rem; }
        .list-info p { margin: 2px 0 0; font-size: 0.75rem; color: var(--text-light); }
        .list-action { width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; margin-left: 5px; }
        .action-del { background: #fee2e2; color: var(--danger); }
        .action-check { background: var(--primary-soft); color: var(--primary); }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(3px); }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .bottom-sheet { position: absolute; bottom: 0; width: 100%; background: var(--surface); border-radius: 30px 30px 0 0; padding: 25px; max-height: 85vh; overflow-y: auto; transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-overlay.open .bottom-sheet { transform: translateY(0); }

        .page { display: none; } .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .upload-area { border: 2px dashed var(--border); border-radius: 16px; padding: 20px; text-align: center; color: var(--text-light); cursor: pointer; background: var(--bg); margin-bottom: 15px; }
        .upload-area img { max-height: 100px; display: none; margin: 10px auto; border-radius: 10px; }
        
        @media print { body * { visibility: hidden; } #invoice-print, #invoice-print * { visibility: visible; } #invoice-print { position: absolute; left: 0; top: 0; width: 100%; } }
    </style>
</head>
<body data-theme="light">

    <header>
        <h1 class="app-title">Ø§Ù„ÙÙ‡Ø¯ <span>Pro</span></h1>
        <div class="theme-btn" onclick="App.toggleTheme()"><i class="fa-solid fa-moon"></i></div>
    </header>

    <main>
        <section id="dashboard" class="page active container">
            <h2 style="margin-bottom:15px">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
            <div class="stats-row">
                <div class="stat-box"><h3><span id="d-daily">0</span></h3><p>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p></div>
                <div class="stat-box"><h3><span id="d-profit" style="color:var(--success)">0</span></h3><p>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</p></div>
            </div>
            <div class="stats-row">
                <div class="stat-box"><h3><span id="d-debts" style="color:var(--danger)">0</span></h3><p>Ø§Ù„Ø¯ÙŠÙˆÙ†</p></div>
                <div class="stat-box"><h3><span id="d-exp">0</span></h3><p>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</p></div>
            </div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
                    <h3>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3><i class="fa-solid fa-chart-line" style="color:var(--primary)"></i>
                </div>
                <div style="height:200px"><canvas id="salesChart"></canvas></div>
            </div>
        </section>

        <section id="pos" class="page container">
            <input type="text" id="searchPos" class="search-bar" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." onkeyup="App.renderPos()">
            <div class="cat-list" id="catList"></div>
            <div class="prod-grid" id="posGrid"></div>
            <div class="cart-bar" id="cartBar" onclick="App.toggleCart()">
                <div style="display:flex; align-items:center; gap:10px">
                    <div class="cart-count" id="cartCount">0</div>
                    <span>Ø§Ù„Ø³Ù„Ø©</span>
                </div>
                <span style="font-weight:800; font-size:1.1rem" id="cartBarTotal">0</span>
            </div>
        </section>

        <section id="debts" class="page container">
            <h2 style="margin-bottom:15px">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ†</h2>
            <div class="card">
                <h4 style="margin-top:0">ØªØ³Ø¬ÙŠÙ„ Ø¯ÙŠÙ† ÙŠØ¯ÙˆÙŠ</h4>
                <div class="input-group">
                    <input type="text" id="newDebtName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†">
                    <input type="number" id="newDebtAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ù…Ø«Ù„Ø§Ù‹ 25 ÙŠØ¹Ù†ÙŠ 25000)">
                </div>
                <button class="btn btn-primary" onclick="App.addManualDebt()">Ø­ÙØ¸ Ø§Ù„Ø¯ÙŠÙ† <i class="fa-solid fa-plus"></i></button>
            </div>
            <input type="text" id="searchDebt" class="search-bar" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù…..." onkeyup="App.renderDebts()">
            <div class="card" id="debtList" style="padding:0"></div>
        </section>

        <section id="invoices" class="page container">
            <h2 style="margin-bottom:15px">Ø³Ø¬Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2>
            <input type="text" id="searchInv" class="search-bar" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„..." onkeyup="App.renderInvoices()">
            <div class="card" id="invList" style="padding:0"></div>
        </section>

        <section id="store" class="page container">
            <h2 style="margin-bottom:15px">Ø§Ù„Ù…Ø®Ø²Ù†</h2>
            <div class="card">
                <div class="upload-area" onclick="document.getElementById('imgInput').click()">
                    <i class="fa-solid fa-camera"></i> <span>ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</span>
                    <img id="previewImg">
                    <input type="file" id="imgInput" accept="image/*" hidden onchange="App.handleImage(this)">
                </div>
                <div class="input-group"><input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"><select id="pCat"><option>Ø¹Ø§Ù…</option><option>Ø±Ø¬Ø§Ù„ÙŠ</option><option>Ù†Ø³Ø§Ø¦ÙŠ</option><option>Ø£Ø·ÙØ§Ù„</option></select></div>
                <div class="input-group"><input type="number" id="pPrice" placeholder="Ø¨ÙŠØ¹ (Ù…Ø«Ù„Ø§Ù‹ 5 ÙŠØ¹Ù†ÙŠ 5000)"><input type="number" id="pCost" placeholder="Ø´Ø±Ø§Ø¡"><input type="number" id="pQty" placeholder="Ø§Ù„Ø¹Ø¯Ø¯"></div>
                <button class="btn btn-primary" onclick="App.addProduct()">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
            </div>
            <div class="input-group"><input type="text" id="searchStore" class="search-bar" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø®Ø²Ù†..." onkeyup="App.renderStore()"></div>
            <div class="card" id="storeList" style="padding:0"></div>
        </section>

        <section id="menu" class="page container">
            <h2 style="margin-bottom:20px">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ</h2>
            
            <div class="card">
                <h4 style="margin-top:0">ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</h4>
                <div class="input-group">
                    <input type="text" id="expDesc" placeholder="Ø§Ù„ÙˆØµÙ (ØºØ¯Ø§Ø¡ØŒ Ù†Ù‚Ù„)">
                    <input type="number" id="expAmt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ù…Ø«Ù„Ø§Ù‹ 5 ÙŠØ¹Ù†ÙŠ 5000)">
                </div>
                <button class="btn btn-danger" onclick="App.addExpense()">ØªØ³Ø¬ÙŠÙ„ ØµØ±Ù</button>
            </div>
            <div class="card" id="expList" style="padding:0"></div>

            <div class="card" onclick="App.exportData()" style="display:flex;align-items:center;gap:15px;margin-top:20px">
                <div style="background:#eef2ff;width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--primary)"><i class="fa-solid fa-download"></i></div>
                <div><h4>Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</h4></div>
            </div>
            <div class="card" onclick="document.getElementById('fileIn').click()" style="display:flex;align-items:center;gap:15px">
                <div style="background:#f0fdf4;width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--success)"><i class="fa-solid fa-upload"></i></div>
                <div><h4>Ø§Ø³ØªØ±Ø¬Ø§Ø¹</h4></div>
                <input type="file" id="fileIn" hidden onchange="App.importData(event)">
            </div>
            <button class="btn btn-danger" onclick="App.resetSys()">ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </section>

    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="App.nav('dashboard', this)"><i class="fa-solid fa-chart-pie"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav-item" onclick="App.nav('pos', this)"><i class="fa-solid fa-cash-register"></i>Ø¨ÙŠØ¹</div>
        <div class="nav-item" onclick="App.nav('debts', this)"><i class="fa-solid fa-book"></i>Ø§Ù„Ø¯ÙŠÙˆÙ†</div>
        <div class="nav-item" onclick="App.nav('invoices', this)"><i class="fa-solid fa-receipt"></i>Ø§Ù„Ø³Ø¬Ù„</div>
        <div class="nav-item" onclick="App.nav('store', this)"><i class="fa-solid fa-box"></i>Ø§Ù„Ù…Ø®Ø²Ù†</div>
        <div class="nav-item" onclick="App.nav('menu', this)"><i class="fa-solid fa-bars"></i>Ø§Ù„Ù…Ø²ÙŠØ¯</div>
    </nav>

    <div class="modal-overlay" id="cartModal">
        <div class="bottom-sheet">
            <div style="display:flex;justify-content:space-between;margin-bottom:20px">
                <h2>Ø§Ù„Ø³Ù„Ø©</h2><i class="fa-solid fa-xmark" onclick="App.toggleCart()" style="font-size:1.5rem"></i>
            </div>
            <div id="cartItems" style="max-height:40vh;overflow-y:auto;margin-bottom:20px"></div>
            <div style="background:var(--bg);padding:15px;border-radius:15px;margin-bottom:15px">
                <div style="display:flex;justify-content:space-between;font-weight:700;margin-bottom:10px"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</span><span id="cartSubTotal">0</span></div>
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px"><span>Ø®ØµÙ…:</span><input type="number" id="cartDiscount" placeholder="0 (Ø¨Ø§Ù„Ø£Ù„Ù)" style="margin:0;width:80px" onchange="App.updateCartUI()"></div>
                <div style="display:flex;justify-content:space-between;font-weight:800;color:var(--primary);font-size:1.2rem;border-top:1px dashed #ccc;padding-top:10px"><span>Ø§Ù„ØµØ§ÙÙŠ</span><span id="cartFinalTotal">0</span></div>
            </div>
            <div style="margin-bottom:15px">
                <select id="payMethod" onchange="App.toggleCustInput()"><option value="cash">Ù†Ù‚Ø¯Ø§Ù‹ ğŸ’µ</option><option value="debt">Ø¢Ø¬Ù„ (Ø¯ÙŠÙ†) ğŸ“’</option></select>
                <input type="text" id="custName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¯ÙŠÙ†)" style="display:none;margin-top:10px">
            </div>
            <button class="btn btn-primary" onclick="App.checkout()">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹</button>
        </div>
    </div>

    <div id="invoice-print" style="display:none; direction:rtl; text-align:center; padding:20px">
        <h2>Ø´Ø±ÙƒØ© Ø§Ù„ÙÙ‡Ø¯</h2><p id="p-date"></p><hr>
        <p>Ø§Ù„ÙˆØµÙ„: <span id="p-id"></span> | Ø§Ù„Ø²Ø¨ÙˆÙ†: <span id="p-client"></span></p>
        <table style="width:100%; border-collapse:collapse; text-align:right"><thead><tr style="border-bottom:1px solid #000"><th>Ù…</th><th>Ø¹</th><th>Ø³</th></tr></thead><tbody id="p-items"></tbody></table>
        <hr><h3>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <span id="p-total"></span></h3>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const App = {
            data: {
                products: JSON.parse(localStorage.getItem('fh_prods')) || [],
                sales: JSON.parse(localStorage.getItem('fh_sales')) || [],
                debts: JSON.parse(localStorage.getItem('fh_debts')) || [],
                expenses: JSON.parse(localStorage.getItem('fh_exps')) || [],
                cart: [],
                tempImg: "",
                activeCat: 'Ø§Ù„ÙƒÙ„'
            },

            init: function() {
                document.body.setAttribute('data-theme', localStorage.getItem('theme')||'light');
                this.refreshAll();
            },

            // --- Navigation ---
            nav: function(id, el) {
                document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                if(el){ document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active')); el.classList.add('active'); }
                if(id==='pos') this.renderPos();
                if(id==='dashboard') this.initChart();
            },

            // --- Core Logic (Multiplication by 1000) ---
            addProduct: function() {
                const n = document.getElementById('pName').value;
                const p = parseFloat(document.getElementById('pPrice').value) * 1000; // Ø¶Ø±Ø¨ ÙÙŠ 1000
                const c = (parseFloat(document.getElementById('pCost').value) || 0) * 1000; // Ø¶Ø±Ø¨ ÙÙŠ 1000
                const q = parseInt(document.getElementById('pQty').value);
                const cat = document.getElementById('pCat').value;

                if(n && p && q) {
                    this.data.products.push({id:Date.now(), name:n, price:p, cost:c, qty:q, cat:cat, img:this.data.tempImg});
                    this.save(); this.renderStore();
                    document.getElementById('pName').value=''; document.getElementById('pPrice').value=''; document.getElementById('pQty').value=''; document.getElementById('pCost').value='';
                    document.getElementById('previewImg').style.display='none'; this.data.tempImg="";
                    alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ (Ø§Ù„Ø³Ø¹Ø± ØªØ­ÙˆÙ„ Ù„Ù„Ø¯ÙŠÙ†Ø§Ø±)");
                }
            },

            addManualDebt: function() {
                const n = document.getElementById('newDebtName').value;
                const a = parseFloat(document.getElementById('newDebtAmt').value) * 1000; // Ø¶Ø±Ø¨ ÙÙŠ 1000
                if(n && a) {
                    this.data.debts.push({id:Date.now(), name:n, amount:a, date:new Date().toLocaleDateString('ar-EG'), invId:'ÙŠØ¯ÙˆÙŠ'});
                    this.save(); this.renderDebts();
                    document.getElementById('newDebtName').value=''; document.getElementById('newDebtAmt').value='';
                }
            },

            addExpense: function() {
                const d = document.getElementById('expDesc').value;
                const a = parseFloat(document.getElementById('expAmt').value) * 1000; // Ø¶Ø±Ø¨ ÙÙŠ 1000
                if(d && a) {
                    this.data.expenses.push({desc:d, amt:a, date:new Date().toLocaleDateString('ar-EG')});
                    this.save(); this.renderExp();
                    document.getElementById('expDesc').value=''; document.getElementById('expAmt').value='';
                    alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ");
                }
            },

            // --- POS & Cart ---
            renderPos: function() {
                const cats = ['Ø§Ù„ÙƒÙ„', ...new Set(this.data.products.map(p=>p.cat))];
                document.getElementById('catList').innerHTML = cats.map(c=>`<div class="cat-chip ${c===this.data.activeCat?'active':''}" onclick="App.filterCat('${c}', this)">${c}</div>`).join('');
                
                const q = document.getElementById('searchPos').value.toLowerCase();
                let list = this.data.products.filter(p=>p.name.toLowerCase().includes(q));
                if(this.data.activeCat!=='Ø§Ù„ÙƒÙ„') list=list.filter(p=>p.cat===this.data.activeCat);
                
                document.getElementById('posGrid').innerHTML = list.map(p=>`
                    <div class="prod-card" onclick="App.addToCart(${p.id})">
                        <div class="badge">${p.qty}</div>
                        <img src="${p.img||'https://via.placeholder.com/150'}" class="prod-img">
                        <div class="prod-details"><div class="prod-title">${p.name}</div><div class="prod-price">${p.price.toLocaleString()}</div></div>
                    </div>`).join('');
                this.updateCartUI();
            },

            filterCat: function(c, el) { this.data.activeCat=c; this.renderPos(); },

            addToCart: function(id) {
                const p = this.data.products.find(x=>x.id===id);
                if(p.qty<=0) return alert("Ù†ÙØ°Øª Ø§Ù„ÙƒÙ…ÙŠØ©");
                const ex = this.data.cart.find(x=>x.id===id);
                if(ex) { if(ex.qty<p.qty)ex.qty++; else return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ù„Ù…Ø²ÙŠØ¯"); }
                else this.data.cart.push({id:p.id, name:p.name, price:p.price, cost:p.cost, qty:1});
                this.updateCartUI();
            },

            updateCartUI: function() {
                const sub = this.data.cart.reduce((a,b)=>a+(b.price*b.qty),0);
                const discInput = parseFloat(document.getElementById('cartDiscount').value) || 0;
                const disc = discInput * 1000; // Ø§Ù„Ø®ØµÙ… Ø¶Ø±Ø¨ ÙÙŠ 1000
                const total = sub - disc;
                
                document.getElementById('cartCount').innerText = this.data.cart.reduce((a,b)=>a+b.qty,0);
                document.getElementById('cartBarTotal').innerText = total.toLocaleString();
                document.getElementById('cartSubTotal').innerText = sub.toLocaleString();
                document.getElementById('cartFinalTotal').innerText = total.toLocaleString();
                
                const bar = document.getElementById('cartBar');
                if(this.data.cart.length>0) bar.classList.add('show'); else { bar.classList.remove('show'); document.getElementById('cartModal').classList.remove('open'); }

                document.getElementById('cartItems').innerHTML = this.data.cart.map((c,i)=>`
                    <div class="list-item">
                        <div class="list-info"><h4>${c.name}</h4><p>${c.price.toLocaleString()} x ${c.qty}</p></div>
                        <strong>${(c.price*c.qty).toLocaleString()}</strong>
                        <button class="list-action action-del" onclick="App.data.cart.splice(${i},1); App.updateCartUI()"><i class="fa-solid fa-minus"></i></button>
                    </div>`).join('');
            },

            toggleCart: function() { document.getElementById('cartModal').classList.toggle('open'); },
            toggleCustInput: function() { 
                const m = document.getElementById('payMethod').value;
                document.getElementById('custName').style.display = m==='debt'?'block':'none'; 
            },

            checkout: function() {
                const method = document.getElementById('payMethod').value;
                const name = document.getElementById('custName').value;
                const discInput = parseFloat(document.getElementById('cartDiscount').value) || 0;
                const disc = discInput * 1000;

                if(method==='debt' && !name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†");
                
                const sub = this.data.cart.reduce((a,b)=>a+(b.price*b.qty),0);
                const cost = this.data.cart.reduce((a,b)=>a+(b.cost*b.qty),0);
                const total = sub - disc;
                const profit = total - cost;

                this.data.cart.forEach(c=>{ const p=this.data.products.find(x=>x.id===c.id); if(p) p.qty-=c.qty });

                const s = {id:"INV"+Date.now().toString().slice(-4), client:name||"Ø¹Ø§Ù…", total, profit, items:[...this.data.cart], date:new Date().toLocaleDateString('ar-EG'), type:method, status:'active'};
                this.data.sales.push(s);
                if(method==='debt') this.data.debts.push({id:Date.now(), name:name, amount:total, date:s.date, invId:s.id});

                this.save(); this.printInv(s); 
                this.data.cart=[]; document.getElementById('cartDiscount').value='';
                this.updateCartUI(); this.renderPos(); alert("ØªÙ… Ø§Ù„Ø¨ÙŠØ¹");
            },

            // --- Rendering Lists ---
            renderStore: function() {
                const q = document.getElementById('searchStore').value.toLowerCase();
                document.getElementById('storeList').innerHTML = this.data.products.filter(p=>p.name.toLowerCase().includes(q)).map((p,i)=>`
                    <div class="list-item" style="padding:15px">
                        <img src="${p.img||''}" style="width:50px;height:50px;border-radius:10px;object-fit:cover;background:#eee">
                        <div class="list-info"><h4>${p.name}</h4><p>${p.qty} Ù‚Ø·Ø¹Ø© | ${p.price.toLocaleString()}</p></div>
                        <button class="list-action action-del" onclick="App.delProd(${p.id})"><i class="fa-solid fa-trash"></i></button>
                    </div>`).join('');
            },
            delProd: function(id) { if(confirm("Ø­Ø°ÙØŸ")){ this.data.products=this.data.products.filter(p=>p.id!==id); this.save(); this.renderStore(); } },

            renderDebts: function() {
                const q = document.getElementById('searchDebt').value.toLowerCase();
                const list = this.data.debts.filter(d => d.name.toLowerCase().includes(q));
                document.getElementById('debtList').innerHTML = list.length ? list.map(d=>`
                    <div class="list-item" style="padding:15px">
                        <div class="list-info"><h4>${d.name}</h4><p>${d.date} - ${d.invId}</p></div>
                        <strong style="color:var(--danger)">${d.amount.toLocaleString()}</strong>
                        <div class="action-group">
                            <button class="list-action action-check" onclick="App.settleDebt(${d.id})"><i class="fa-solid fa-check"></i></button>
                            <button class="list-action action-del" onclick="App.delDebt(${d.id})"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>`).join('') : '<p style="text-align:center;padding:20px;color:#999">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ†</p>';
                document.getElementById('d-debts').innerText = this.data.debts.reduce((a,b)=>a+b.amount,0).toLocaleString();
            },
            settleDebt: function(id) { if(confirm("ØªØ³Ø¯ÙŠØ¯ØŸ")) { this.data.debts=this.data.debts.filter(d=>d.id!==id); this.save(); this.renderDebts(); } },
            delDebt: function(id) { if(confirm("Ø­Ø°ÙØŸ")) { this.data.debts=this.data.debts.filter(d=>d.id!==id); this.save(); this.renderDebts(); } },

            renderInvoices: function() {
                const q = document.getElementById('searchInv').value.toLowerCase();
                document.getElementById('invList').innerHTML = this.data.sales.slice().reverse().filter(s=>s.id.toLowerCase().includes(q)||s.client.includes(q)).map(s=>`
                    <div class="list-item" style="padding:15px;opacity:${s.status==='refunded'?0.6:1}">
                        <div class="list-info"><h4>${s.client} <span style="font-size:0.7rem;background:#eee;padding:2px 5px;border-radius:4px">${s.type}</span></h4><p>${s.id} | ${s.date} ${s.status==='refunded'?'(Ù…Ø±ØªØ¬Ø¹)':''}</p></div>
                        <strong>${s.total.toLocaleString()}</strong>
                        <div class="action-group">
                            <button class="list-action" onclick='App.printInv(${JSON.stringify(s)})'><i class="fa-solid fa-print"></i></button>
                            ${s.status==='active'?`<button class="list-action action-del" onclick="App.refund('${s.id}')"><i class="fa-solid fa-rotate-left"></i></button>`:''}
                        </div>
                    </div>`).join('');
            },
            refund: function(id) {
                const s = this.data.sales.find(x=>x.id===id);
                if(s && confirm("Ø§Ø³ØªØ±Ø¬Ø§Ø¹ØŸ")) {
                    s.items.forEach(i=>{ const p=this.data.products.find(x=>x.id===i.id); if(p) p.qty+=i.qty });
                    if(s.type==='debt'){ this.data.debts = this.data.debts.filter(d=>d.invId!==id); }
                    s.status='refunded'; s.profit=0; this.save(); this.refreshAll();
                }
            },

            renderExp: function() {
                document.getElementById('expList').innerHTML = this.data.expenses.slice().reverse().map((e,i)=>`
                    <div class="list-item" style="padding:15px">
                        <div class="list-info"><h4>${e.desc}</h4><p>${e.date}</p></div>
                        <strong style="color:var(--warning)">${e.amt.toLocaleString()}</strong>
                        <button class="list-action action-del" onclick="App.data.expenses.splice(${this.data.expenses.length-1-i},1);App.save();App.renderExp()"><i class="fa-solid fa-trash"></i></button>
                    </div>`).join('');
                document.getElementById('d-exp').innerText = this.data.expenses.reduce((a,b)=>a+b.amt,0).toLocaleString();
            },

            // --- Utils ---
            handleImage: function(inpt) {
                const f=inpt.files[0]; if(f){ const r=new FileReader(); r.onload=e=>{ const i=new Image(); i.src=e.target.result; i.onload=()=>{
                    const c=document.createElement('canvas'); const x=c.getContext('2d');
                    c.width=300; c.height=i.height*(300/i.width); x.drawImage(i,0,0,c.width,c.height);
                    this.data.tempImg=c.toDataURL('image/jpeg',0.7); document.getElementById('previewImg').src=this.data.tempImg; document.getElementById('previewImg').style.display='block';
                }}; r.readAsDataURL(f); }
            },
            initChart: function() {
                const today = new Date().toLocaleDateString('ar-EG');
                document.getElementById('d-daily').innerText = this.data.sales.filter(s=>s.date===today).reduce((a,b)=>a+b.total,0).toLocaleString();
                document.getElementById('d-profit').innerText = this.data.sales.reduce((a,b)=>a+b.profit,0).toLocaleString();
                
                const ctx = document.getElementById('salesChart').getContext('2d');
                new Chart(ctx, {type:'line', data:{labels:['Ø³','Ø£','Ù†','Ø«','Ø±','Ø®','Ø¬'], datasets:[{label:'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', data:[0,0,0,0,0,0, this.data.sales.reduce((a,b)=>a+b.total,0)], borderColor:'#4f46e5', tension:0.4, fill:true, backgroundColor:'rgba(79,70,229,0.1)'}]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}}});
            },
            save: function(){ localStorage.setItem('fh_prods',JSON.stringify(this.data.products)); localStorage.setItem('fh_sales',JSON.stringify(this.data.sales)); localStorage.setItem('fh_debts',JSON.stringify(this.data.debts)); localStorage.setItem('fh_exps',JSON.stringify(this.data.expenses)); this.refreshAll(); },
            refreshAll: function(){ this.renderStore(); this.renderDebts(); this.renderInvoices(); this.renderExp(); this.initChart(); },
            toggleTheme: function(){ const t=document.body.getAttribute('data-theme')==='light'?'dark':'light'; document.body.setAttribute('data-theme',t); localStorage.setItem('theme',t); },
            printInv: function(s){ document.getElementById('p-id').innerText=s.id; document.getElementById('p-total').innerText=s.total.toLocaleString(); document.getElementById('p-date').innerText=s.date; document.getElementById('p-client').innerText=s.client; document.getElementById('p-items').innerHTML=s.items.map(i=>`<tr><td>${i.name}</td><td>${i.qty}</td><td>${i.price.toLocaleString()}</td></tr>`).join(''); window.print(); },
            exportData: function(){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(this.data)],{type:'application/json'})); a.download="Backup.json"; a.click(); },
            importData: function(e){ const r=new FileReader(); r.onload=v=>{ const d=JSON.parse(v.target.result); this.data=d; this.save(); alert("ØªÙ…"); location.reload(); }; r.readAsText(e.target.files[0]); },
            resetSys: function(){ if(confirm("Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ØŸ")) { localStorage.clear(); location.reload(); } }
        };
        App.init();
    </script>
</body>
</html>
